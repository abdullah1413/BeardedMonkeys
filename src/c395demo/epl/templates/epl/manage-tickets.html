{% extends 'epl/index.html' %}

{% block content %}

<html>
<head>
	<title>Branch Tickets</title>
	{% load static %}

    <link rel="stylesheet" type="text/css" href="/static/demo/main.css" />
    <link rel="stylesheet" type="text/css" href="/static/demo/normalize.css" />
    <link rel="stylesheet" type="text/css" href="/static/demo/grid.css" />
    <link href="https://fortawesome.github.io/Font-Awesome/assets/font-awesome/css/font-awesome.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

	<script src="{% static '/demo/sorttable.js' %}"></script>
    <script>
    $(document).ready(function () {
                size_tr = $("#ticket-table tr").size();
                x=11;
                if (size_tr <= 11) {
                   $('#loadMore').hide();
                }
                else {
                   $('#loadMore').show();
                }
                $('#ticket-table tr').hide();
                $('#ticket-table tr:lt('+x+')').show();
                     $('#loadMore').click(function () {
                         x= (x+10 <= size_tr) ? x+10 : size_tr;
                         $('#ticket-table tr:lt('+x+')').show();
                         if (x >= size_tr) {
                            $('#loadMore').hide();
                         }
                     });
    });
    </script>
</head>
<body>
    <h1>Branch Tickets</h1>
	<table class="sortable" id="ticket-table">
	    <thead>
	        <tr>
	            <th>ID</th>
	            <th>Author</th>
	            <th>Date</th>
	            <th>Category</th>
	            <th>Status</th>
	            <th class= "sorttable_nosort">Description</th>
	            <th class= "sorttable_nosort">Options</th>
	        </tr>
	    </thead>
	    <tbody>
	    {% load descGet %}
	    {% for callLog in callLogs %}
	        {% if callLog.Category in available %}
                <tr>
                    <td> {{ callLog.CallID }} </td>
                    <td> {{ callLog.CustID }} </td>
                    <td> {{ callLog.RecvdDate|get_date }} </td>
                    <td> {{ callLog.Category }} </td>
                    <td id="status_{{ callLog.CallID }}"> {{ callLog.CallStatus }} </td>
                    <td style="text-align:left;"> {% descGet callLog.CallID %} </td>
                    <td>
                        <a href="{% url 'detail' id=callLog.CallID %}" style="display:inline-block;">
                            <div class="button"><i class="fa fa-folder-open-o" aria-hidden="true"></i> View</div>
                        </a>
                        <!-- replace edit button with approve button if user is manager and ticket is non-approved -->
                        {% if callLog.CallStatus == "Unapproved" or callLog.CallStatus == "Disapproved" %}
                            {% if branch == "manager" %}
                                <a id="appBtn_{{ callLog.CallID }}" class="cursor button" style="display:inline-block;"> <div>
                                        <i class="fa fa-check" aria-hidden="true"></i> Approve
                                    </div></a>
                            {% else %}
                                 <a href="edit.asp" class="button disabled" style="display:inline-block; background-color: grey" >
                                     <div ><i class="fa fa-pencil" aria-hidden="true"></i> Edit</div>
                                 </a>
                            {% endif %}
                        {% else %}
                            <!-- Allow editing for ticket owners -->
                            {% if user.username == callLog.CustID %}
                                <a href="edit.asp" style="display:inline-block;">
                                    <div class="button"><i class="fa fa-pencil" aria-hidden="true"></i> Edit</div>
                                </a>
                            {% else %}
                                <a href="edit.asp" class="button disabled" style="display:inline-block; background-color: grey" >
                                    <div ><i class="fa fa-pencil" aria-hidden="true"></i> Edit</div>
                                </a>
                            {% endif %}
                        {% endif %}

                         <!--IT functionality -->
                        {% if branch == "IT" %}
                            <a id="myBtn_{{ callLog.CallID }}" class="cursor button" style="display:inline-block;"> <div>
                                {% if callLog.CallStatus == "Open" %}
                                    <i class="fa fa-check" aria-hidden="true"></i> Resolved
                                {% else %}
                                    <i class="fa fa-check" aria-hidden="true"></i> Re-open
                                {% endif %}
                            </div></a>
                        <!-- If user is manager, replace resolve/reopen button with disapprove button if ticket is non-approved -->    
                        {% elif branch == "manager" %}
                                {% if callLog.CallStatus == "Unapproved" or callLog.CallStatus == "Disapproved" %}
                                <a id="disBtn_{{ callLog.CallID }}" class="cursor button" style="display:inline-block;"> <div>
                                    <i class="fa fa-check" aria-hidden="true"></i> Disapprove
                                {% else %}
                                    <a id="myBtn_{{ callLog.CallID }}" class="cursor button" style="display:inline-block;"> <div>
                                    {% if callLog.CallStatus == "Open" %}
                                        <i class="fa fa-check" aria-hidden="true"></i> Resolved
                                    {% else %}
                                        <i class="fa fa-check" aria-hidden="true"></i> Re-open
                                    {% endif %}
                                {% endif %}
                            </div></a>
                            
                        {% else %}
                        <!--check if the user is owner of the ticket. Owners can resolve/reopen approved tickets.-->
                            {% if callLog.CallStatus != "Unapproved" and callLog.CallStatus != "Disapproved" %}
                                {% if user.username == callLog.CustID %}
                                    <a id="myBtn_{{ callLog.CallID }}" class="cursor button" style="display:inline-block;"> <div>
                                        {% if callLog.CallStatus == "Open" %}
                                            <i class="fa fa-check" aria-hidden="true"></i> Resolved
                                        {% else %}
                                            <i class="fa fa-check" aria-hidden="true"></i> Re-open
                                        {% endif %}
                                    </div></a>
                                {% else %}
                                    <a style="display:inline-block;"> <div class="button disabled" style="background-color:grey;" >
                                        {% if callLog.CallStatus == "Open" %}
                                            <i class="fa fa-check" aria-hidden="true"></i> Resolved
                                        {% else %}
                                            <i class="fa fa-check" aria-hidden="true"></i> Re-open
                                        {% endif %}
                                    </div></a>
                                {% endif %}
                            {% else %}
                                <a style="display:inline-block;"> <div class="button disabled" style="background-color:grey;" >
                                        <i class="fa fa-check" aria-hidden="true"></i> Open
                                </div></a>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
            {% endif %}
	    {% endfor %}
	    </tbody>
    </table>
    <div align="center">
        <button id="loadMore">Load More Tickets</input>
    </div>
    <BR><BR>
    <div id="myModal" class="modal">
      <!-- Resolve/reopen popup window -->
      <div class="modal-content">
          <span class="close">&times;</span>
          <p id="modalText">Are you sure the ticket has been resolved?</p>
          <a class="button modalButton nButton cursor" style="float:right">No</a><!-- add class and remove id-->
          <a class="button modalButton" style="visibility:hidden;"></a>
          <a id="yButton" class="button modalButton cursor" style="float:right; margin-right:20px;">Yes</a>
      </div>
    </div>
    <div id="appModal" class="modal">
      <!-- Manager approve ticket popup window -->
      <div class="modal-content">
          <span class="close">&times;</span>
          <p id="appModalText">Are you sure you wish to approve the ticket?</p>
          <a class="button modalButton nButton cursor" style="float:right">No</a>
          <a class="button modalButton" style="visibility:hidden;"></a>
          <a id="appYButton" class="button modalButton cursor" style="float:right; margin-right:20px;">Yes</a>
      </div>
    </div>
    <div id="disModal" class="modal">
      <!-- Manager disapprove ticket popup window -->
      <div class="modal-content">
          <span class="close">&times;</span>
          <p id="disModalText">Are you sure you wish to disapprove the ticket?</p>
          <a class="button modalButton nButton cursor" style="float:right">No</a>
          <a class="button modalButton" style="visibility:hidden;"></a>
          <a id="disYButton" class="button modalButton cursor" style="float:right; margin-right:20px;">Yes</a>
      </div>
    </div>
</body>
</html>

{% endblock %}
